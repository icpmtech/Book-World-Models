---
id: chapter-09
title: Scenario Generation and Counterfactual Futures
sidebar_label: "Chapter 9 â€” Scenario Generation"
sidebar_position: 10
---

import Link from '@docusaurus/Link';

# Chapter 9

## Scenario Generation and Counterfactual Futures

World models allow **counterfactual reasoning** â€” the ability to ask "what if?" and receive a
quantified, probabilistic answer rather than a verbal narrative.

- What if oil drops 20%?
- What if rates spike unexpectedly?
- What if earnings compress simultaneously across sectors?

The system can:

- **Inject shocks** into the latent state
- **Simulate propagation** across the causal graph
- **Measure systemic impact** as a full probability distribution

This transforms risk management into **experimental science**.

---

## The Portfolio Simulation Engine

> **Try the interactive tool â†’**
> [ðŸ“Š Portfolio Simulation Engine](/portfolio-simulation)
>
> Enter real stock symbols (e.g. `AAPL`, `MSFT`, `SPY`), set portfolio weights, and run a
> World Model Monte Carlo simulation to generate a fan chart of 4,000 possible futures â€” with
> live price data from Yahoo Finance.

A World Model simulation engine evaluates a portfolio not by replaying history but by generating
a **probability distribution over future portfolio trajectories**.

### Architecture

![Portfolio Simulation Engine architecture diagram](/img/portfolio-simulation-engine.svg)

The simulation pipeline operates in six stages:

1. **Encode** the current portfolio state and market prices into a latent vector `z_t`
2. **Infer** the current macro regime (Expansion, Overheating, Contraction, Recovery)
3. **Simulate** thousands of independent forward trajectories
4. **Evaluate** five resilience metrics across all trajectories
5. **Aggregate** into a composite resilience score
6. **Optimise** portfolio weights to maximise resilience-weighted expected return

---

## Simulation Fan Charts

The key output of the simulation engine is a **fan chart** â€” a visualisation of the full
probability distribution of future portfolio values.

![Simulation fan chart showing probability bands](/img/simulation-fan-chart.svg)

The fan chart displays:

| Band | Interpretation |
|---|---|
| **Median path** | Most likely single trajectory |
| **P25â€“P75 band** | The interquartile range â€” half of all simulated paths fall here |
| **P10â€“P90 band** | 80% of simulated paths â€” the central scenario space |

Unlike a single backtest line, the fan chart makes **uncertainty explicit and quantifiable**.

---

## Counterfactual Scenario Generation

### State Injection

Counterfactual scenarios are generated by injecting a shock vector `Î´` into the latent state:

```
z_t* = z_t + Î´_scenario
```

where `Î´_scenario` encodes the hypothetical shock (e.g. oil price drop, credit spread widening,
earnings revision).

### Propagation Through the Causal Graph

![Causal chain propagation](/img/causal-chain.svg)

The world model propagates the shock through the learned causal structure:

```
z_{t+1} ~ p_Î¸(z_{t+1} | z_t*, r_t)
o_{t+1}  = Decoder(z_{t+1})
```

Each downstream effect is modelled as a probability distribution, not a point estimate.

### Systemic Impact Measurement

The difference between the **baseline distribution** and the **shocked distribution** quantifies
systemic impact:

```
Impact(Î´) = E[R | z_t*] - E[R | z_t]
         = Scenario premium (or penalty)
```

---

## The Regime Cycle

Market regimes determine the volatility and correlation structure of returns. The world model
continuously estimates the probability of being in each regime.

![Market regime cycle diagram](/img/regime-cycle.svg)

| Regime | Characteristics | Simulation Adjustment |
|---|---|---|
| **Expansion** ðŸŸ¢ | Rising earnings, stable rates | Baseline volatility |
| **Overheating** ðŸŸ  | Tight labour, rising inflation | +20% volatility scaling |
| **Contraction** ðŸ”´ | Falling earnings, credit stress | +40% volatility scaling |
| **Recovery** ðŸŸ¡ | Stimulus, re-leveraging | Baseline with fat tails |

---

## Resilience Metrics Across Scenarios

### The Five Resilience Metrics

![Portfolio resilience metrics](/img/portfolio-resilience-metrics.svg)

For each simulated trajectory, five resilience metrics are computed:

| Metric | Definition | Formula |
|---|---|---|
| **Max Drawdown** | Worst peak-to-trough decline | `DD = (peak - trough) / peak` |
| **Recovery Time** | Months to recover from drawdown | `min{t : V(t) â‰¥ V(peak)}` |
| **Dividend Sustainability** | P(dividends maintained) | `P(payout_ratio < 1)` |
| **Bankruptcy Probability** | P(any holding defaults) | `1 - âˆ P(solvency_k)` |
| **Volatility Clustering** | Fraction of paths with high-vol regime | `#{paths with Ïƒ > 2Ïƒ_baseline} / N` |

### Resilience-Weighted Optimisation

```
Maximise: E[R_portfolio] âˆ’ Î»â‚Â·P(DD > threshold)
                         âˆ’ Î»â‚‚Â·E[RecoveryTime]
                         âˆ’ Î»â‚ƒÂ·P(dividend cut)
                         âˆ’ Î»â‚„Â·P(default)
                         âˆ’ Î»â‚…Â·VolClusterExposure
```

---

## Investment Decision Loop

The simulation engine is embedded in a continuous investment decision loop:

![Investment decision loop](/img/investment-decision-loop.svg)

```
Observe â†’ Encode â†’ Infer Regime â†’ Simulate â†’ Evaluate â†’ Optimise â†’ Act â†’ Observe
```

Each cycle:
1. New market observations update the latent state
2. The regime probability distribution is revised
3. A fresh set of simulations is run
4. The optimal portfolio weights are recomputed
5. Trades are executed to rebalance toward the optimal weights

---

## World Model vs Traditional Approaches

### Hidden State Inference

Unlike LLMs and traditional factor models, world models maintain an explicit **hidden state**
that captures latent market structure.

![Hidden state inference diagram](/img/hidden-state-inference.svg)

This hidden state encodes:
- Current macro regime probabilities
- Volatility regime and correlation structure
- Momentum and mean-reversion dynamics
- Latent credit stress indicators

### Investment Return Comparison

![Investment return comparison across approaches](/img/investment-return-comparison.svg)

| Approach | Uncertainty | Causal | Counterfactual | Actionable |
|---|---|---|---|---|
| LLM Response | None | No | No | No |
| Factor Model | Partial | No | No | Partially |
| Monte Carlo (raw) | Yes | No | No | Partially |
| **World Model** | **Full distribution** | **Yes** | **Yes** | **Yes** |

---

## Practical Example: Stress-Testing a Portfolio

Suppose we hold a portfolio of `AAPL (30%) + MSFT (25%) + SPY (45%)`.

We inject a **rate shock scenario**: rates rise 200bp in 3 months.

The world model:
1. Encodes the shock into `Î´ = [rate_shock: +2.0%, duration_impact: high]`
2. Propagates through the causal graph: growth stocks re-price, tech multiples compress
3. Generates 10,000 trajectories under the shocked state
4. Reports: `P(DD > 15%) = 42%`, `Expected Recovery: 8 months`

Without the world model, this analysis would require a bespoke analyst model for each scenario.
With it, any counterfactual is evaluated in seconds.

---

## Interactive Portfolio Simulation Engine

<div style={{
  background: 'linear-gradient(135deg, #0a1628, #1a4b8c)',
  borderRadius: '12px',
  padding: '1.5rem 2rem',
  textAlign: 'center',
  margin: '1.5rem 0',
}}>
  <h3 style={{ color: '#fff', margin: '0 0 0.5rem' }}>ðŸ“Š Try the Portfolio Simulation Engine</h3>
  <p style={{ color: '#93c5fd', margin: '0 0 1rem', fontSize: '0.95rem' }}>
    Enter real stock symbols, set weights, and run a World Model Monte Carlo simulation
    with live Yahoo Finance price data.
  </p>
  <Link
    to="/portfolio-simulation"
    style={{
      display: 'inline-block',
      background: '#22c55e',
      color: '#fff',
      borderRadius: '6px',
      padding: '0.6rem 1.5rem',
      fontWeight: 'bold',
      textDecoration: 'none',
      fontSize: '1rem',
    }}
  >
    Launch Portfolio Simulation Engine â†’
  </Link>
</div>

---

## Chapter Summary

- World models enable **counterfactual reasoning** by injecting shocks into a learned latent state and simulating forward propagation.
- The **Portfolio Simulation Engine** generates a full probability distribution â€” not a single number â€” as its output, represented as a fan chart across thousands of trajectories.
- **Regime awareness** adjusts volatility scaling dynamically: contraction regimes receive +40% vol scaling, overheating +20%.
- Five resilience metrics â€” Maximum Drawdown, Recovery Time, Dividend Sustainability, Bankruptcy Probability, and Volatility Clustering â€” quantify portfolio risk across the full distribution.
- The investment decision loop continuously updates regime estimates and re-optimises weights as new market observations arrive.
- The interactive **Portfolio Simulation Engine tool** demonstrates these concepts using real Yahoo Finance price data and Monte Carlo world-model forecasting.

